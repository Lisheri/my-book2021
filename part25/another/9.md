# Virtual DOM的工作原理是什么？

## Virtual DOM

Virtual DOM也称为虚拟DOM，在为什么要使用JSX中我们说到， 为了更便捷高效的使用声明式开发组件，引入了XML语法结构的JSX。JSX经过编译过后会被babel翻译为类似React.createElement函数包裹标签及属性。那么这里的React.createElement函数所返回的就是一个虚拟DOM。虚拟DOM并不是只有React才有，而是经过React发扬光大变得流行起来。Vue1.0升级到2.0.最大的变化就是引入了虚拟DOM。

## 历史

React的原型是XHP， 该框架于2010年开源。FaceBook创建XHP的目的主要有两点：

+ 简化前端开发，按照现在流行的说法叫后端赋能，让后端开发人员能够快速的交付页面。
+ 避免跨站脚本攻击，也就是常说的XSS攻击，FaceBook拥有庞大的站点，很容易因为一处暴露XSS而造成整体的风险。XSS不会直接攻击网页，而是通过嵌入JS代码将恶意攻击附加到用户请求中来攻击用户(反射形XSS， 或存储形XSS。他可以被用作窃取用户信息，或者恶意增删用户的一些资料。而XHP最大的优势在于默认开启XSS防御。

所有的页面在XHP中构建完成，并没有直接的HTML，都是通过转义的方式生成的。这样的过程确保可以在XHP中写出安全的静态页面，但如果需要构建动态的网页应用就会出问题。意味着一旦状态发生改变，网页就需要重新渲染，从而丢失之前网页中的信息。FaceBook团队很早就意识到了这个问题对于页面性能和用户体验来说十分糟糕。这就使他们产生了思考: 仅仅因为状态改变就不得不重新渲染整个页面？

在2011年，FaceBook的工程师Joodan Walke开始研究能使这个过程更加高效，用户体验更合理的原型方案。这就是React最初的构想，不再基于XHP，而是基于JS的用户界面构建库。

2012年， Instagram团队希望在技术中使用React，在技术栈上开始向faceBook取经。正因为这个请求，才让React从FaceBook内部脱离出来，成为之后开源的基础。2013年5月，faceBook正式宣布开源React。

回顾历史，就会发现，最开始Facebook的目的就是简化前端开发，解决XSS注入的问题。解决方案也很粗暴，就是不直接操作DOM，通过虚拟DOM规避风险，因此有了今天的虚拟DOM。

基于基本认知，React中有两个函数：

+ diff函数，去计算状态改变前后的虚拟DOM差异
+ render函数，渲染整个DOM树或处理差异点

这就是为什么React有两个库要引入，一个是React， 一个是ReactDOM。就是由于要计算与渲染的分工。

其中React主要是组件实现、更新调度等计算工作，而ReactDOM提供了在网页上渲染的基础

也正是因为这些拆分， 当React向IOS、安卓开发时候， 只需要React Native提供Native层的元素渲染即可。

## 优势

将前面的一整理，就会得出DOM有这几个优势：

+ 性能优越
+ 规避XSS
+ 可跨平台

当然，这样的答案是有问题的，讨论优势的时候一定要考虑边界。

有经验的面试官会问：“虚拟DOM一定会比真实DOM操作性能更高吗”。

答：“其实不是，如果只修改一个按钮的文案，那么虚拟DOM的操作无论如何都不可能比真实DOM更快，所以一定要回到具体场景进行探讨。”

如果大量的直接操作DOM就会引起网页性能下降，这时React基于虚拟DOM的diff处理与批处理操作，可以降低DOM的操作范围和频次，提升页面性能。在这样的场景下，虚拟DOM就是比较快。至于首次渲染与微量操作，虚拟DOM的速度就是比真实DOM慢了。

那么虚拟DOM一定可以规避XSS吗？虚拟DOM内部做了字符串的转义，因此确实可以做到这一点。但是也有风险，因为React留有dangerouslySetInnerHTML API 绕过转义。

没有虚拟DOM不能实现跨平台吗？比如NativeScript没有虚拟DOM层，它是通过提供兼容原生API的JS API实现跨平台开发。那么虚拟DOM优势在哪里？实际上它的优势在于跨平台的成本更低。在RN之后，前端社区从虚拟DOM中体会到了跨平台的无限前景，所以在后续的发展中，都借鉴了虚拟DOM。比如：社区流行的小程序同构方案，在构建过程中会提供类似虚拟DOM的结构描述对象，来支撑多端转换。

## 缺点

社区公认缺点有两个：

+ 内存占用较高。因为当前网页的虚拟DOM包含了真实DOM的完整信息，而且由于是Object， 内存占用肯定会有所上升
+ 无法进行极致优化。虽然虚拟DOM足以应对绝大部分应用的性能需求，但在一些性能要求极高的应用中， 虚拟DOM无法进行针对性的极致优化， 比如实现类似Google Earth的场景。

## 答题

虚拟DOM的工作原理是通过JS对象模拟DOM的节点。在Facebook构建React初期时， 考虑到要提升代码抽象能力、避免人为的DOM操作、避免人为的DOM操作、降低代码整体风险等因素，所以引入了虚拟DOM

虚拟DOM在实现上通常是Plain Object，以React为例， 在render函数中写的JSX会在Babel插件的作用下，编译为React,createElement执行JSX中的属性参数

React.createElement执行后会返回一个Plain Object， 他会描述自己的tag类型、props属性以及children的情况等。这些Plain Object通过树形结构组成一颗虚拟DOM树。当状态发生变更时， 将变更前后的虚拟DOM树进行差异比较，这个过程称为diff，生成的结果称为patch。计算之后， 会渲染Patch完成对真实DOM的操作。

虚拟DOM的优点主要有三点: 改善大规模DOM操作的性能、规避XSS风险、能以较低的成本实现跨平台开发。

虚拟DOM的缺点在社区中主要有两点

+ 内存占用较高， 因为需要模拟整个网页的真实DOM
+ 高性能应用场景存在难以优化的情况，类似像Google Earth一类的高性能前端应用在技术选型上往往不会选择React。




