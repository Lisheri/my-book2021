# 四次挥手

+ 建立一个连接需要三次握手, 而终止一个连接需要四次挥手。这是由于TCP半关闭造成的。所谓半关闭其实就是TCP提供连接的一方在结束他的发送后还可以接受来自另一端的数据
+ TCP拆除连接需要发送四个包因此称为四次挥手, 客户端和服务端均可发起挥手动作(以下假设客户端发起挥手动作)
+ 第一次挥手: 客户端发起一个FIN报文, 客户端处于FIN_WAIT1状态, 报文中指定一个序列号
+ 第二次挥手: 服务端收到FIN之后, 会发送ACK报文, 且吧客户端的序列号值 +1 作为ACk报文的序列号, 表明已经收到了客户端的报文, 此时服务端处于CLOSE_WAIT状态
    - 即服务端收到了客户端的连接释放报文段(ACK=1, 确认号ack=u+1, 序列号seq=v), 服务端进入CLOSE_WAIT(关闭等待)状态, 此时的TCP处于半关闭状态, 客户端到服务端的连接释放。客户端收到服务端的确认后, 进入FIN_WAIT2状态, 等待服务端发起连接释放报文段
+ 第三次挥手: 如果服务端也想断开连接了, 就和第一次客户端一样,发送一个FIN报文给客户端, 并指定一个序列号, 此时服务端处于LAST_ACK状态（并没有要向客户端发送的数据, 纯粹发出一个释放报文）
+ 第四次挥手: 客户端收到FIN报文后, 一样发送一个ACK报文作为应答, 并且把服务端的序列号值+1作为自己的ACK报文的序列号值, 此时客户端处于TIME_WAIT状态。需要过一阵子以确保服务端收到自己的ACK报文之后才进入CLOSED状态, 服务端收到客户端发送的ACK之后, 就处于CLOSED状态了
    - 发出ACK之后, 客户端进入TIME_WAIT状态, 此时TCP连接还没有释放, 需要经过等待时间计时器设置的2MSL后, 客户端才进入CLOSED状态
+ 在socket中任何一方执行close()方法都会执行挥手操作

## 挥手为什么需要四次

+ 因为当服务器收到客户端的SYN连接请求后, 可以直接发送SYN+ACK报文。其中ACK报文是用来应答的, SYN报文是用来同步的。但是关闭连接时, 放服务端收到FIN报文后, 很可能并不会立即关闭socket, 所以只能先回复一个ACK报文表示你的断开请求我收到了, 只有等我所有的报文都发送完了, 我才能发送FIN报文, 因此不能一起发送, 所以挥手需要四次

## 2MSL等待的意义

TIME_WAIT状态也被称为2MSL等待状态。 MSL是值报文段最大生存时间，他是任何一个报文段被丢弃前在网络内的最长时间。这个时间是有限的, 因为TCP报文段以IP数据报在网络内传输, 而IP数据报则有限制其生存时间的TTL字段

处理原则主要是当TCP执行主动关闭, 并发回最后的ACK, 该链接必须在TIME_WAIT状态停留时间为2倍的MSL, 这样可以让TCP再次发送最后的ACK以防这个ACK丢失(另一端超时重发最后的FIN)

意义：
+ 主要是保证客户端发送的最后一个ACK报文段能够抵达服务端(给他时间重发)
+ 防止 “已失效的连接请求报文段”再次出现在本连接中(发送最后一个ACK后, 等待2MSL, 就可以使本连接中持续时间所产生的所有报文段都从网络中消失, 移除出全连接队列)